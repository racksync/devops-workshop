# ความปลอดภัยของซัพพลายเชนในDigitalOcean Kubernetes

## บทนำ

คู่มือนี้ให้คำแนะนำโดยย่อเกี่ยวกับแนวปฏิบัติที่ดีที่สุดด้านความปลอดภัยของ Kubernetes โดยทั่วไป (ใช้ได้กับ [DOKS](https://docs.digitalocean.com/products/kubernetes/) เช่นกัน) จากนั้นจะมีตัวอย่างภาคปฏิบัติเกี่ยวกับวิธีการผสานเครื่องมือสแกนหาช่องโหว่ยอดนิยม (เช่น [Kubescape](https://github.com/armosec/kubescape/)) ในไปป์ไลน์ CI/CD แบบดั้งเดิมที่ใช้ [GitHub Workflows](https://docs.github.com/en/actions/using-workflows)

[Kubernetes](https://kubernetes.io) ได้รับความนิยมอย่างมากในช่วงที่ผ่านมาและมีเหตุผลที่ดี ปัจจุบันถูกใช้อย่างกว้างขวางในทุกโครงสร้างพื้นฐานสมัยใหม่ที่อิงตาม microservices Kubernetes ช่วยลดภาระในการจัดการการตั้งค่าความพร้อมใช้งานสูง (หรือ HA) เช่น การจัดกำหนดการและการสร้างสำเนาเวิร์กโหลดบนโหนดต่างๆ จึงรับประกันความยืดหยุ่น จากนั้นในระดับเครือข่าย ยังดูแลการโหลดบาลานซ์และกระจายทราฟฟิกอย่างสม่ำเสมอไปยังเวิร์กโหลด ในแก่นแท้แล้ว Kubernetes คือตัวจัดกำหนดการคอนเทนเนอร์ที่ทันสมัยซึ่งนำเสนอฟีเจอร์เพิ่มเติมเช่น การจัดการคอนฟิกแอปพลิเคชันและซีเคร็ต เป็นต้น คุณยังสามารถกำหนดโควต้าและควบคุมการเข้าถึงทรัพยากรต่างๆ ของแอปพลิเคชัน (เช่น CPU และหน่วยความจำ) โดยการปรับแต่งคำขอขีดจำกัดทรัพยากร ในแง่ของความปลอดภัย คุณสามารถจำกัดผู้ที่มีสิทธิ์เข้าถึงทรัพยากรต่างๆ ผ่านนโยบาย RBAC ซึ่งเป็นตัวย่อของ Resource Based Access Control

Kubernetes เติบโตขึ้นอย่างมากในแง่ของความเสถียรและความสมบูรณ์ในช่วงหลายปีที่ผ่านมา ในทางกลับกัน เนื่องจากความนิยมจึงกลายเป็นเป้าหมายที่อาจถูกโจมตีได้ ไม่ว่าคุณจะใช้งาน Kubernetes ที่ใด (คลาวด์หรือออนพรีมิส) แต่ละคลัสเตอร์แบ่งออกเป็นสององค์ประกอบหลัก:

1. [Control Plane](https://kubernetes.io/docs/concepts/overview/components/#control-plane-components) - ดูแลการจัดกำหนดการเวิร์กโหลดของคุณ (Pods) และตอบสนองต่อเหตุการณ์ของคลัสเตอร์ (เช่น การเริ่มต้นพ็อดใหม่เมื่อฟิลด์ replicas ของการปรับใช้ไม่เป็นที่พอใจ)
2. [Worker Nodes](https://kubernetes.io/docs/concepts/overview/components/#node-components) - เครื่องจริงที่รันเวิร์กโหลด Kubernetes ของคุณ ส่วนประกอบของโหนดทำงานบนทุกโหนด รักษาพ็อดที่ทำงานอยู่และให้สภาพแวดล้อมการทำงานของ Kubernetes

ภาพด้านล่างแสดงสถาปัตยกรรมทั่วไปของคลัสเตอร์ Kubernetes และจุดอ่อนที่เป็นไปได้:

![Kubernetes Architecture Overview](assets/images/DOKS_Overview.png)

ผู้ให้บริการคลาวด์ (รวมถึง [DigitalOcean](https://www.digitalocean.com)) เสนอวันนี้บริการ [Kubernetes](https://docs.digitalocean.com/products/kubernetes/) ที่พร้อมใช้งาน จึงช่วยลดภาระในการจัดการคลัสเตอร์เอง (หรือส่วนประกอบของ control plane) ด้วยวิธีนี้ คุณสามารถมุ่งเน้นไปที่การพัฒนาแอปพลิเคชันมากกว่าการใช้เวลาในการจัดการงานโครงสร้างพื้นฐาน เช่น การจัดการ control plane การบำรุงรักษาโหนดทำงาน (เช่น การอัปเดตระบบปฏิบัติการเป็นประจำและการแก้ไขความปลอดภัย) เป็นต้น DigitalOcean นำเสนอแพลตฟอร์ม Kubernetes ที่ใช้งานง่ายที่เรียกว่า [DOKS](https://docs.digitalocean.com/products/kubernetes/) ซึ่งย่อมาจาก DigitalOcean Kubernetes DOKS เป็นบริการ [Kubernetes ที่มีการจัดการ](https://docs.digitalocean.com/products/kubernetes/resources/managed/) ที่ให้คุณปรับใช้คลัสเตอร์ Kubernetes โดยไม่ต้องจัดการกับความซับซ้อนของการติดตั้งและการจัดการส่วนประกอบ control plane และโครงสร้างพื้นฐานที่เป็นคอนเทนเนอร์

ต่อไปนี้เป็นแง่มุมที่สำคัญมากซึ่งมักถูกมองข้ามคือ **ความปลอดภัย** ความปลอดภัยเป็นคำที่กว้างกว่าและครอบคลุมหลายด้าน เช่น ความปลอดภัยของซัพพลายเชนซอฟต์แวร์ ความปลอดภัยของโครงสร้างพื้นฐาน ความปลอดภัยของเครือข่าย เป็นต้น เนื่องจาก Kubernetes เป็นที่นิยมมากจึงกลายเป็นเป้าหมายที่อาจถูกโจมตีได้ ดังนั้นจึงต้องระมัดระวัง อีกแง่มุมหนึ่งที่ต้องพิจารณาคือความซับซ้อนของระบบนิเวศ Kubernetes โดยทั่วไป ระบบที่ซับซ้อนสามารถมีจุดอ่อนหลายจุด จึงเปิดประตูหลายบานให้กับการโจมตีและการใช้ประโยชน์จากภายนอก ข้อบกพร่องด้านความปลอดภัยส่วนใหญ่เกิดจากการกำหนดค่าคลัสเตอร์ Kubernetes ที่ไม่เหมาะสม ตัวอย่างทั่วไปคือผู้ดูแลระบบคลัสเตอร์ลืมตั้งค่ากฎ RBAC หรืออนุญาตให้แอปพลิเคชันทำงานเป็น root ในสเปกของพ็อด ต่อไป Kubernetes นำเสนอกลไกการแยกที่เรียบง่ายแต่ทรงพลังมาก (ทั้งในระดับแอปพลิเคชันและระดับเครือข่าย) - [namespaces](https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/) โดยการใช้ namespaces ผู้ดูแลระบบสามารถแยกทรัพยากรแอปพลิเคชันและกำหนดค่ากฎการเข้าถึงให้กับผู้ใช้และ/หรือทีมต่างๆ ได้อย่างควบคุมมากขึ้น

การทำให้ Kubernetes แข็งแกร่งขึ้นเป็นกระบวนการหลายขั้นตอน และมักประกอบด้วย:

1. การทำให้ control plane แข็งแกร่งขึ้น:
   - ลดการโจมตีพื้นผิวโดยการรักษาความปลอดภัย REST API สาธารณะของ Kubernetes (การอนุญาต การตรวจสอบสิทธิ์ การเข้ารหัส TLS)
   - อัปเดตเคอร์เนลของระบบปฏิบัติการเป็นประจำผ่านแพตช์เพื่อรวมการแก้ไขความปลอดภัย นอกจากนี้ ไลบรารีและไบนารีของระบบจะต้องอัปเดตเป็นประจำ
   - บังคับใช้นโยบายเครือข่ายและกำหนดค่าไฟร์วอลล์เครือข่ายเพื่อให้สามารถเข้าถึงได้ขั้นต่ำถึงศูนย์หากเป็นไปได้จากภายนอก เริ่มต้นด้วยการปฏิเสธทุกอย่าง จากนั้นอนุญาตเฉพาะบริการที่จำเป็นเท่านั้น
   - **อย่าเปิดเผยฐานข้อมูล ETCD ต่อสาธารณะ!** นี่เป็นขั้นตอนที่สำคัญมาก เนื่องจากฐานข้อมูล Kubernetes ETCD มีการกำหนดค่าและสถานะทรัพยากรของคุณ นอกจากนี้ยังอาจมีข้อมูลที่ละเอียดอ่อน เช่น ซีเคร็ตของ Kubernetes
   - จำกัดการเข้าถึงกลุ่มคนที่จำกัดมาก (โดยปกติคือผู้ดูแลระบบ)
   - ทำการตรวจสอบระบบเป็นประจำโดยการติดตั้ง/กำหนดค่าเครื่องมือตรวจสอบความปลอดภัย และรับการแจ้งเตือนแบบเรียลไทม์ในกรณีที่มีการละเมิดความปลอดภัย
2. การทำให้โหนดทำงานแข็งแกร่งขึ้น คำแนะนำส่วนใหญ่ของ control plane ใช้ที่นี่เช่นกัน โดยมีข้อสังเกตบางประการ เช่น:
   - อย่าเปิดเผย [kubelets](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) หรือ [kube-proxies](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/) ต่อสาธารณะ
   - หลีกเลี่ยงการเปิดเผยบริการ SSH ต่อสาธารณะ ขอแนะนำเพื่อลดการโจมตีพื้นผิว สำหรับการดูแลระบบ คุณสามารถใช้การตั้งค่า VPN
3. การทำให้สภาพแวดล้อมแอปพลิเคชัน Kubernetes แข็งแกร่งขึ้น:
   - การสแกน Kubernetes YAML manifests เพื่อหาการกำหนดค่าที่ไม่ถูกต้อง
   - สิทธิ์ที่เข้มงวดสำหรับพ็อดและคอนเทนเนอร์ (เช่น ไม่อนุญาตให้ผู้ใช้ root ภายในสเปกของพ็อด ระบบไฟล์ที่ไม่เปลี่ยนแปลงสำหรับคอนเทนเนอร์ เป็นต้น)
   - การกำหนดค่าที่เหมาะสมของนโยบาย RBAC
   - การลงนามในภาพคอนเทนเนอร์ จึงอนุญาตให้ใช้เฉพาะภาพที่เชื่อถือได้เท่านั้น
   - การตั้งค่าตัวควบคุมการยอมรับเพื่ออนุญาตเฉพาะภาพคอนเทนเนอร์ที่เชื่อถือได้ (หรือที่ลงนามแล้ว) เท่านั้น
   - นโยบายเครือข่ายและการแยก namespace (จำกัดแอปพลิเคชันไปยัง namespaces เฉพาะ รวมถึงการควบคุมทราฟฟิก ingress/egress ระหว่าง namespaces)
   - การสแกนคลัสเตอร์ Kubernetes เป็นระยะ
4. การทำให้ซัพพลายเชนซอฟต์แวร์แข็งแกร่งขึ้น:
   - การสแกนซอร์สโค้ดของแอปพลิเคชันและไลบรารีของบุคคลที่สามเพื่อหาช่องโหว่ที่ทราบ
   - การสแกนภาพคอนเทนเนอร์ของแอปพลิเคชันเพื่อหาช่องโหว่ที่ทราบ

ภาพด้านล่างแสดงขั้นตอนที่แนะนำเพื่อให้บรรลุความปลอดภัยตั้งแต่ต้นทางถึงปลายทางสำหรับ Kubernetes:

![DOKS End to End Security](asssets/../assets/images/DOKS_E2E_Security.png)

ในกรณีของ DOKS คุณไม่ต้องกังวลเกี่ยวกับความปลอดภัยของ control plane และโหนดทำงาน เนื่องจากผู้ให้บริการคลาวด์ (DigitalOcean) ดูแลเรื่องนี้แล้ว นี่เป็นหนึ่งในประโยชน์หลักของการใช้บริการ Kubernetes ที่มีการจัดการ อย่างไรก็ตาม ผู้ใช้สามารถเข้าถึงเครื่องพื้นฐาน (Droplets) และการตั้งค่าไฟร์วอลล์ได้ ดังนั้นทั้งหมดจึงวนกลับไปที่ความรอบคอบของผู้ดูแลระบบเพื่อให้ความสนใจและไม่เปิดเผยบริการหรือพอร์ตที่ไม่จำเป็นจริงๆ

สิ่งที่เหลืออยู่คือการดำเนินการเพื่อทำให้สภาพแวดล้อมแอปพลิเคชัน Kubernetes และซัพพลายเชนซอฟต์แวร์แข็งแกร่งขึ้น คู่มือนี้มุ่งเน้นไปที่ความปลอดภัยของซัพพลายเชน Kubernetes เป็นหลัก และจะสอนคุณ:

1. เรียกใช้การสแกนหาช่องโหว่ในระยะแรก เช่น ภายในไปป์ไลน์ CI/CD ของคุณ (Tekton, Jenkins, GitHub workflows เป็นต้น)
2. เรียกใช้การสแกนเป็นระยะภายในคลัสเตอร์ Kubernetes ของคุณ รวมถึงการปรับใช้ใหม่ใดๆ
3. ประเมินความเสี่ยงด้านความปลอดภัยและดำเนินการที่เหมาะสมเพื่อลดปัจจัยเสี่ยงให้น้อยที่สุด
4. รับการแจ้งเตือนแบบเรียลไทม์ (เช่น ผ่าน Slack) เกี่ยวกับภัยคุกคามที่อาจเกิดขึ้นในคลัสเตอร์ Kubernetes ของคุณ

## ความปลอดภัยของสภาพแวดล้อม Kubernetes และซัพพลายเชนซอฟต์แวร์

ในการสร้างแอปพลิเคชันและเรียกใช้บน Kubernetes คุณต้องมีรายการส่วนประกอบที่เป็นส่วนหนึ่งของซัพพลายเชนซอฟต์แวร์ ซัพพลายเชนซอฟต์แวร์มักประกอบด้วย:

- ที่เก็บ Git ที่ดึงซอร์สโค้ดแอปพลิเคชันของคุณ
- ไลบรารีของบุคคลที่สามที่แอปพลิเคชันของคุณอาจใช้ (ดึงผ่านเครื่องมือการจัดการโปรเจ็กต์ เช่น npm, maven, gradle เป็นต้น)
- ภาพ Docker ที่โฮสต์แอปพลิเคชันของคุณ (รวมถึงภาพฐานที่สืบทอดมา)
- YAML manifests ที่บอกให้ Kubernetes สร้างทรัพยากรที่จำเป็นสำหรับแอปพลิเคชันของคุณให้ทำงาน เช่น Pods, Deployments, Secrets, ConfigMaps เป็นต้น

การทำให้สภาพแวดล้อมแอปพลิเคชัน Kubernetes และซัพพลายเชนซอฟต์แวร์แข็งแกร่งขึ้นสามารถทำได้ในระยะแรกที่ระดับไปป์ไลน์ CI/CD โครงสร้างพื้นฐานสมัยใหม่ทุกแห่งใช้ระบบ CI/CD ในปัจจุบันเพื่อสร้างและปรับใช้แอปพลิเคชัน ดังนั้นเหตุผล

ขั้นตอนแรกที่จำเป็นในการทำให้สภาพแวดล้อม Kubernetes ของคุณแข็งแกร่งขึ้นคือการใช้เครื่องมือเฉพาะที่สแกนหาช่องโหว่อย่างต่อเนื่องทั้งในระดับไปป์ไลน์ CI/CD และคลัสเตอร์ Kubernetes ทั้งหมด

มีเครื่องมือสแกนหาช่องโหว่มากมาย แต่คู่มือนี้มุ่งเน้นไปที่การใช้งานสองอย่าง - [Snyk](https://snyk.io) และ [Armosec Kubescape](https://github.com/armosec/kubescape/)

โดยไม่ต้องกังวลใจ โปรดเลือกหนึ่งรายการเพื่อเริ่มต้นจากรายการด้านล่าง

## เครื่องมือสแกนหาช่องโหว่ Kubernetes

| SNYK | KUBESCAPE |
|:-----------------------------------------------:|:--------------------------------------------------------------:|
| [![Snyk](assets/images/snyk/logo.png)](snyk.md) | [![Kubescape](assets/images/kubescape/logo.png)](kubescape.md) |
